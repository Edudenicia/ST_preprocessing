---
title: "Create a distance raster from spatial points"
author: "Ricardo Ochoa, Eduardo Denicia"
date: "8/28/2018"
output: html_document
---

This tutorial will guide you in a step-by-step process to create create a distance raster from spatial points. This tutorial considers that you are already familiar with the following concepts. If you are not, please visit the links.

- [R](https://www.r-project.org/)
- [RStudio](https://www.rstudio.com)
- [Raster](https://en.wikipedia.org/wiki/Raster_graphics)

## Introduction 
Urban studies commonly depend on assessing how city services are distributed in the city. However, technical teams commonly struggle to generate, maintain or retrive detailed spatial information. The following R code explains how to create a **raster** (GeoTif) in which each pixel includes the minimum distance (crow-flight) to the closest hospital. In this tutorial we will use data from hospitals in Mexico City and the output from the [Create a raster with built-up area from GHSL data](https://github.com/ricardoochoa/ST_preprocessing/tree/master/build_up_area) tutorial.

## 1. Prepare data
Please download the data from our GitHub repository: 

## 2. Load required libraries
In this tutorial we will use the following libraries:
[raster](https://cran.r-project.org/web/packages/raster/raster.pdf): Title Geographic Data Analysis and Modeling Version 2.6-7, November 12, 2017
[rgdal](https://cran.r-project.org/web/packages/rgdal/rgdal.pdf): Bindings for the 'Geospatial' Data Abstraction, Version 1.3-4, August 3, 2018
[sp](https://cran.r-project.org/web/packages/sp/sp.pdf): Classes and Methods for Spatial Data, Version 1.3-1, June 5, 2018
[leaflet](https://cran.r-project.org/web/packages/leaflet/leaflet.pdf): Create Interactive Web Maps with the JavaScript 'Leaflet', Version 2.0.2, August 27, 2018

Run the following lines to load the libraries. 

```{r 2 libraries, include=TRUE, echo=TRUE, message=FALSE}
# install.packages('raster')    # Run only once
# install.packages('rgdal')     # Run only once
# install.packages('sp')        # Run only once
# install.packages('leaflet')   # Run only once
library(raster)
library(rgdal)
library(sp)
library(leaflet)
```

## Data
```{r data boundaries}
boundaries <- readOGR("_raw/Sofifi Shapefiles/Deliniasi.shp")
boundaries <- spTransform(boundaries, CRS("+proj=longlat +ellps=WGS84 +datum=WGS84"))
plot(boundaries)

empty_raster <- raster(ncol=180, nrow=180, ext = extent(bbox(boundaries)))
r <- rasterize(boundaries, empty_raster, fun='first')
plot(r)

writeRaster(x = r, filename = paste0("_output/sofifi/dummy_filter.tif"), overwrite=TRUE)  

facilitas <- read.csv("_raw/Sofifi Shapefiles/Fasilitas.csv")

for(remark in levels(facilitas$REMARK)){
  points <- coordinates(subset(facilitas, REMARK == remark)[c("X", "Y")])
  temp <- distanceFromPoints(object = r, xy = points)*r
  
  tiff.name <- remark
  tiff.name <- gsub(pattern = "/", replacement = "_", x = tiff.name)
  tiff.name <- gsub(pattern = " ", replacement = "_", x = tiff.name)
  
  writeRaster(x = temp, filename = paste0("_output/sofifi/", tiff.name, ".tif"), overwrite=TRUE)  
}
```

## Plot

```{r plot, echo=FALSE}
plot(temp)
```

Final notes...
